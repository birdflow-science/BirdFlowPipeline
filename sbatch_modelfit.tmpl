#!/bin/bash

## Job Resource Interface Definition
##
## ntasks [integer(1)]:       Number of required tasks,
##                            Set larger than 1 if you want to further parallelize
##                            with MPI within your job.
## ncpus [integer(1)]:        Number of required cpus per task,
##                            Set larger than 1 if you want to further parallelize
##                            with multicore/parallel within each task.
## walltime [integer(1)]:     Walltime for this job, in seconds.
##                            Must be at least 60 seconds for Slurm to work properly.
## memory   [integer(1)]:     Memory in megabytes for each cpu.
##                            Must be at least 100 (when I tried lower values my
##                            jobs did not start at all).
##
## Default resources can be set in your .batchtools.conf.R by defining the variable
## 'default.resources' as a named list.

<%
# relative paths are not handled well by Slurm
log.file = fs::path_expand(log.file)
-%>

#SBATCH --ntasks=1
#SBATCH --cpus-per-task=<%= resources$ncpus %>
#SBATCH --gpus-per-task=<%= resources$ngpus %>
#SBATCH --mem=<%= resources$mymem %>GB  # Requested Memory
#SBATCH --time=<%= ceiling(resources$walltime / 60) %>
#SBATCH --job-name=<%= job.name %>
#SBATCH --output=<%= log.file %>
#SBATCH --error=<%= log.file %>
<%= if (!is.null(resources$partition)) sprintf(paste0("#SBATCH --partition='", resources$partition, "'")) %>
<%= if (array.jobs) sprintf("#SBATCH --array=1-%i", nrow(jobs)) else "" %>

## Export value of DEBUGME environemnt var to slave
export DEBUGME=<%= Sys.getenv("DEBUGME") %>

TZ='America/Los_Angeles' date
whoami
hostname
source /etc/profile
module load miniconda
conda activate jax_gpu
python3 <%= resources$mypy %> <%= resources$mydir %> <%= resources$mysp %> <%= resources$myres %> --obs_weight=<%= resources$mf_obs_weight %> --dist_weight=<%= resources$mf_dist_weight %> --ent_weight=<%= resources$mf_ent_weight %> --dist_pow=<%= resources$mf_dist_pow %> --learning_rate=<%= resources$mf_learning_rate %> --training_steps=<%= resources$mf_training_steps %> --rng_seed=<%= resources$mf_rng_seed %>
TZ='America/Los_Angeles' date
