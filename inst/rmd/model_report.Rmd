---
title: "BirdFlow model summary for `r bf$species$common_name`"
subtitle: "`r sub('\\.hdf5$', '', ll_df$model[i])`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# fix issue of tables not being formatted properly in html
# https://github.com/STAT545-UBC/Discussion/issues/136
options(knitr.table.format = 'markdown')
options(rgl.useNULL = TRUE) # Suppress the separate window
```

### Preprocessing info

- eBird Status and Trends version: `r bf$metadata$ebird_version_year`
- grid resolution: `r params$my_res` km

### Grid search

Grid size: `r length(params$grid_search_list$obs_prop)` x `r length(params$grid_search_list$de_ratio)` x `r length(params$grid_search_list$dist_pow)` = `r prod(sapply(params$grid_search_list, length))`

Gridded hyperparameters:

- obs_prop: `r params$grid_search_list$obs_prop`

- de_ratio: `r params$grid_search_list$de_ratio`

- dist_pow: `r params$grid_search_list$dist_pow`

Hyperparameters calculated from de_ratio and obs_prop:

- dist_weight

- ent_weight

Hyperparameters passed to modelfit:

- dist_weight

- ent_weight

- dist_pow

```{r plot3d, echo = FALSE}
rgl::mfrow3d(nr = 1, nc = 2)

cols_3d <- rep('gray', nrow(ll_df))
cols_3d[i] <- 'red'

rgl::plot3d(
  x = ll_df$de_ratio, y = ll_df$obs_prop, z = ll_df$dist_pow,
  col = cols_3d,
  type = 's',
  xlab="de_ratio", ylab="obs_prop", zlab="dist_pow")

rgl::plot3d(
  x = ll_df$ent_weight, y = ll_df$dist_weight, z = ll_df$dist_pow,
  col = cols_3d,
  type = 's',
  xlab="ent_weight", ylab="dist_weight", zlab="dist_pow")

rgl::rglwidget()
```

### Hyperparameters

```{r hyperparameters, echo = FALSE}
knitr::kable(
  ll_df[i, c('de_ratio', 'obs_prop', 'dist_pow', 'dist_weight', 'ent_weight', 'obs_weight')]
  )
```

### Model selection crtieria

- evaluation season: `r params$season`
- desirability method: `r params$model_selection`

### Correlation and calibration

```{r cor_cal, echo = FALSE}
knitr::kable(
  signif(ll_df[i, c('end_traverse_cor', 'pit_row', 'pit_col', 'pit_in_95')],
         digits = 3)
  )
```

### Calibration plots

```{r cal_plots, echo = FALSE, fig.height = 5, fig.width = 5}
cal_pdf_dir <- file.path(params$output_path, 'pit_plots', sub('\\.hdf5$', '', ll_df$model[i]))
include_files <- c('pit_score_rows.pdf', 'pit_score_cols.pdf', 'pit_transition_prob_obs.pdf')
include_files <- file.path(cal_pdf_dir, include_files)
knitr::include_graphics(include_files, rel_path = FALSE)
```

### Desirability

- desirability rank within grid search: `r i`

```{r desirability, echo = FALSE}
knitr::kable(
  round(ll_df[i, c('d_pit_row', 'd_pit_col', 'd_pit_in_95', 'pit_d', 'etc_d', 'str_d', 'nso_d', 'overall_des')],
        digits = 3)
)
```

### Simulated route map (n = 10)

```{r route_map, echo = FALSE, message = FALSE}
rts <- BirdFlowR::route(bf = bf, n = 10, season = params$season, from_marginals = TRUE)
  print(
    BirdFlowR::plot_routes(rts, bf, use_seasonal_colors = FALSE) +
      ggplot2::labs(title = NULL)
  )
```

### Route characteristics

```{r route_stats, echo = FALSE, message = FALSE}

route_stats_df <- dplyr::bind_rows(
  ll_df[i, c('straightness', 'length', 'displacement', 'n_stopovers')],
  as.data.frame(
    readRDS(
      file.path(
        params$output_path,
        'real_track_stats.rds'
      )
    )
  )
) %>%
  dplyr::mutate(routes = c('simulated (n = 100)', 'real')) %>%
  dplyr::select('routes', everything()) %>%
  dplyr::mutate(straightness = round(straightness, 2)) %>%
  dplyr::mutate(length = round(length, 0)) %>%
  dplyr::mutate(displacement = round(displacement, 0)) %>%
  dplyr::mutate(n_stopovers = round(n_stopovers, 1))

knitr::kable(route_stats_df)
```
