---
title: "BirdFlow model report for `r bf$species$common_name`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# fix issue of tables not being formatted properly in html
# https://github.com/STAT545-UBC/Discussion/issues/136
options(knitr.table.format = 'markdown')
options(rgl.useNULL = TRUE) # Suppress the separate window
```

### Target season: `r params$season`

# Quick summary

### Model quality assessment (please read limitations document)

```{r qual_glance, echo = FALSE}
old_knitr_table_format <- options()$knitr.table.format
qdf <- data.frame(
  criterion = c(
    'Correlation with Status and Trends',
    'Model calibration',
    'Simulated routes: straightness',
    'Simulated routes: number of stopovers'
  ),
  assessment = NA_character_,
  color = NA_character_
  )
convert_to_color_category <- function(x, breaks, labels){
  as.character(cut(x = x, breaks = breaks, labels = labels))
}
# Correlation with Status and Trends
out_row <- match('Correlation with Status and Trends', qdf$criterion)
x <- ll_df$end_traverse_cor[i]
out_color <- convert_to_color_category(x, breaks = c(0, 0.95, 0.975, 1), labels = c("red", "yellow", "green"))
qdf[out_row, 'color'] <- out_color
# Model calibration
out_row <- match('Model calibration', qdf$criterion)
x <- ll_df$d_pit_in_95[i]
out_color <- convert_to_color_category(x, breaks = c(0, 0.6, 0.8, 1), labels = c("red", "yellow", "green"))
qdf[out_row, 'color'] <- out_color
# real vs. simulated route metrics df, duplicated code in other chunk below
mdf <- dplyr::bind_rows(
  ll_df[i, c('straightness', 'length', 'displacement', 'n_stopovers')],
  as.data.frame(
    readRDS(
      file.path(
        params$output_path,
        'real_track_stats.rds'
      )
    )
  )
)
# Simulated routes: straightness
out_row <- match('Simulated routes: straightness', qdf$criterion)
x <- abs((mdf$straightness[2] - mdf$straightness[1])/mdf$straightness[1])
out_color <- convert_to_color_category(x, breaks = c(0, 0.2, 0.4, Inf), labels = c("green", "yellow", "red"))
qdf[out_row, 'color'] <- out_color
# Simulated routes: number of stopovers
out_row <- match('Simulated routes: number of stopovers', qdf$criterion)
x <- abs((mdf$n_stopovers[2] - mdf$n_stopovers[1]))
out_color <- convert_to_color_category(x, breaks = c(0, 0.5, 1, Inf), labels = c("green", "yellow", "red"))
qdf[out_row, 'color'] <- out_color

# Convert color column to qualitative assessment descriptor word
qdf$assessment <- dplyr::case_match(qdf$color,
                                    'green' ~ 'good',
                                    'yellow' ~ 'acceptable',
                                    'red' ~ 'tentative')
# Render table
qdf$assessment <- kableExtra::cell_spec(qdf$assessment, background = qdf$color)
kableExtra::kable(qdf[,c('criterion', 'assessment')], format = "html", escape = FALSE) %>%
  kableExtra::kable_styling()

# restore table formatting
options(knitr.table.format = old_knitr_table_format)
```

### Simulated route map (n = 10)

```{r route_map, echo = FALSE, message = FALSE}
rts <- BirdFlowR::route(bf = bf, n = 10, season = params$season, from_marginals = TRUE)
  print(
    BirdFlowR::plot_routes(rts, bf, use_seasonal_colors = FALSE) +
      ggplot2::labs(title = NULL)
  )
```

### Route characteristics

```{r route_stats, echo = FALSE, message = FALSE}

route_stats_df <- dplyr::bind_rows(
  ll_df[i, c('straightness', 'length', 'displacement', 'n_stopovers')],
  as.data.frame(
    readRDS(
      file.path(
        params$output_path,
        'real_track_stats.rds'
      )
    )
  )
) %>%
  dplyr::mutate(routes = c('simulated (n = 100)', 'real tracking data')) %>%
  dplyr::select('routes', everything()) %>%
  dplyr::mutate(straightness = round(straightness, 2)) %>%
  dplyr::mutate(length = round(length, 0)) %>%
  dplyr::mutate(displacement = round(displacement, 0)) %>%
  dplyr::mutate(n_stopovers = round(n_stopovers, 1))

knitr::kable(route_stats_df[,c('routes', 'straightness', 'n_stopovers')])
```

# Technical details

### Internal model filename

`r sub('\\.hdf5$', '', ll_df$model[i])`

### eBird Status and Trends data preprocessing

- version year: `r bf$metadata$ebird_version_year`
- raster resolution: `r params$my_res` km

### Grid search setup

Parameters for grid expansion

- obs_prop: `r params$grid_search_list$obs_prop`

  - proportion of all weights allocated to the observation weight.
  
  - generally, we want the model to closely follow eBird Status and Trends distributions

- de_ratio: `r params$grid_search_list$de_ratio`

  - specifying this ratio (dist_weight / ent_weight) is useful because this proportion strongly affects simulated routes 

- dist_pow: `r params$grid_search_list$dist_pow`

  - this hyperparameter controls the relative cost of many short movements vs. few long movements

Grid size

- `r length(params$grid_search_list$obs_prop)` x `r length(params$grid_search_list$de_ratio)` x `r length(params$grid_search_list$dist_pow)` = `r prod(sapply(params$grid_search_list, length))`

Hyperparameters calculated from de_ratio and obs_prop

- dist_weight

- ent_weight

Hyperparameters passed to model fitting process on GPU

- dist_weight

- ent_weight

- dist_pow

### Grid search space

Parameters for grid expansion (left); hyperparameters passed to model fitting process (right)

```{r plot3d, echo = FALSE}

rgl::clear3d()
rgl::mfrow3d(nr = 1, nc = 2)

cols_3d <- rep('gray', nrow(ll_df))
cols_3d[i] <- 'red'

rgl::plot3d(
  x = ll_df$de_ratio, y = ll_df$obs_prop, z = ll_df$dist_pow,
  col = cols_3d,
  type = 's',
  xlab="de_ratio", ylab="obs_prop", zlab="dist_pow")

rgl::plot3d(
  x = ll_df$ent_weight, y = ll_df$dist_weight, z = ll_df$dist_pow,
  col = cols_3d,
  type = 's',
  xlab="ent_weight", ylab="dist_weight", zlab="dist_pow")

rgl::rglwidget()
```

### Hyperparameters


```{r hypers, echo = FALSE}
knitr::kable(
  ll_df[i, c('de_ratio', 'obs_prop', 'dist_pow', 'dist_weight', 'ent_weight', 'obs_weight')]
  )
```

### Model selection

- model selection target season: `r params$season`

- desirability criteria: `r params$model_selection`

  - this desirability method co-optimizes the following

    - overall model calibration score (which itself is a co-optimization of row and column PIT scores and PIT 95% CI)
    - "end traverse correlation" with eBird Status and Trends data (start with modeled distribution at season start, forward-predict distribution to season end, then compare with S&T distribution at season end)
    - average number of stopovers in simulated tracks targets average number of stopovers in real tracks
    - average straightness of simulated tracks targets average straightness of real tracks

### Correlation and calibration

```{r cor_cal, echo = FALSE, fig.show="hold", out.width="33%"}

# Table

knitr::kable(
  signif(ll_df[i, c('end_traverse_cor', 'pit_row', 'pit_col', 'pit_in_95')],
         digits = 3)
  )

# Plots

pit_data_path <- file.path(params$output_path, 'pit_data', paste0(sub('\\.hdf5$', '', ll_df$model[i]), '_pit.rds'))
pit_calibration_obj <- readRDS(pit_data_path)
pit_plots_report(pit_calibration_obj, params)
```

### Desirability

Overall desirability rank within grid search: `r i`


```{r desirability_tab, echo = FALSE}
# Table
knitr::kable(
  round(ll_df[i, c('d_pit_row', 'd_pit_col', 'd_pit_in_95', 'pit_d', 'etc_d', 'str_d', 'nso_d', 'overall_des')],
        digits = 3),
  caption = 'desirability sub-scores for this model'
)
```

Desirability sub-scores for this model vs. all models in this grid search

```{r desirability_graph, echo = FALSE, message = FALSE}

# Graph
d_vars <- grep('^d_|_d$|overall_des$', names(ll_df), value = TRUE)
df <- ll_df[,d_vars]
df$color <- rep('black', nrow(df))
df$color[i] <- 'red'
df <- tidyr::pivot_longer(df, tidyr::all_of(d_vars), names_to = 'variable', values_to = 'desirability')
df$variable <- factor(df$variable, levels = d_vars)
# 
# ggplot2::ggplot(df, ggplot2::aes(x=variable, y=desirability), shape = 19) +
#   ggplot2::geom_dotplot(ggplot2::aes(fill = color), binaxis='y', stackdir='center', dotsize = 0.3, show.legend = FALSE, stroke = NA, binpositions = "all") + 
#   ggplot2::scale_fill_identity() +
#   ggplot2::theme_bw()

# Base R graph

ncol <- 4
nrow <- ceiling(length(d_vars)/ ncol)

# function to place text in plotting window 
# where x and y represent the proprtion of the length
# along the given axis to locate the lable text.
ptext <- function(x,y, labels, ...){
  usr <- par("usr")
  xlim <- c(usr[1], usr[2])
  ylim <- c(usr[3], usr[4])	
  x <- xlim[1]+(xlim[2]-xlim[1])*x
  y <- ylim[1]+(ylim[2]-ylim[1])*y	
  text(x, y, labels, ...)
} # end function def.


  
par(mfrow = c(nrow, ncol), mar = c(2.1, 2.1, 1.1, 1.1))
for(i in seq_along(d_vars)){
  var <- d_vars[i]
  plot(density(df$desirability[df$variable == var]), main  = "", xlab = var, xlim = c(0,1))
  sel_val <- df$desirability[df$color == "red" & df$variable == var]
  abline(v = sel_val, col = "red")  
  ptext(0.05, .9, var, pos = 4)
}

```
