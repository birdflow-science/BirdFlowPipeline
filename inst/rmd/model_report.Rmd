---
title: "BirdFlow model summary for `r bf$species$common_name`"
subtitle: "`r sub('\\.hdf5$', '', ll_df$model[i])`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Preprocessing info

- eBird Status and Trends version: `r bf$metadata$ebird_version_year`
- grid resolution: `r params$my_res` km

Hyperparameters

```{r hyperparameters, echo = FALSE}
kableExtra::kbl(
  ll_df[i, c('de_ratio', 'obs_prop', 'dist_pow', 'dist_weight', 'ent_weight', 'obs_weight')]
  )
```

Grid search context

```{r grid_search_context, echo = FALSE, message = FALSE}
grid_search_context_plot <- function(ll_df, row_chosen = i){
  columns_chosen <- c('de_ratio', 'obs_prop', 'dist_pow', 'dist_weight', 'ent_weight')
  ll_df_scaled <- ll_df <- ll_df[,columns_chosen]
  for (i in columns_chosen){
    ll_df_scaled[[i]] <- desirability2::d_max(ll_df_scaled[[i]], use_data = TRUE)
  }
  ll_df_scaled
  barplot(height = sapply(ll_df_scaled[row_chosen,], as.numeric),
          ylim = c(0,1),
          main = 'Grid search context',
          ylab = 'Scaled value'
  )
}
grid_search_context_plot(ll_df, i)
```

Model selection crtieria

- evaluation season: `r params$season`
- desirability method: `r params$model_selection`

Correlation and calibration

```{r cor_cal, echo = FALSE}
kableExtra::kbl(
  ll_df[i, c('end_traverse_cor', 'pit_row', 'pit_col', 'pit_in_95')]
  )
```

Calibration plots

```{r cal_plots, echo = FALSE, fig.height = 5, fig.width = 5}
cal_pdf_dir <- file.path(params$output_path, 'pit_plots', sub('\\.hdf5$', '', ll_df$model[i]))
include_files <- c('pit_score_rows.pdf', 'pit_score_cols.pdf', 'pit_transition_prob_obs.pdf')
include_files <- file.path(cal_pdf_dir, include_files)
knitr::include_graphics(include_files, rel_path = FALSE)
```

Desirability

- desirability rank within grid search: `r i`

```{r desirability, echo = FALSE}
kableExtra::kbl(
    ll_df[i, c('d_pit_row', 'd_pit_col', 'd_pit_in_95', 'pit_d', 'etc_d', 'str_d', 'nso_d', 'overall_des'), drop = FALSE]
)
```

Simulated route map (n = 10)

```{r route_map, echo = FALSE, message = FALSE}
rts <- BirdFlowR::route(bf = bf, n = 10, season = params$season, from_marginals = TRUE)
  print(
    BirdFlowR::plot_routes(rts, bf, use_seasonal_colors = FALSE)
  )
```

Simulated route stats (n = 100)

```{r route_stats, echo = FALSE, message = FALSE}
kableExtra::kbl(
  ll_df[i, c('straightness', 'length', 'displacement', 'n_stopovers')]
  )
```

Real tracking route stats

```{r real_route_stats, echo = FALSE, message = FALSE}
kableExtra::kbl(
  as.data.frame(
    readRDS(
      file.path(
        params$output_path,
        'real_track_stats.rds'
      )
    )
  )
)
```

